/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model where all user-generated content is stored
 * within a user-specific document tree. It provides a clear separation between private, user-owned data and
 * globally accessible public data. The primary goal is strong authorization while maintaining flexibility for
 * rapid application prototyping.
 *
 * Data Structure: The core data structure is `/users/{userId}`, which acts as the root for all data owned by a
 * specific user, including their profile, sharing cards, and associated marketplace links. Publicly readable
 * content, such as satirical presets, buzzword definitions, and class archetypes, is stored in separate top-level collections.
 *
 * Key Security Decisions:
 * - User Isolation: A user can only access and manage data within their own `/users/{userId}` path.
 * - No User Enumeration: Listing documents in the top-level `/users` collection is explicitly forbidden to protect user privacy.
 * - Public Data is Read-Only: Collections like `satire_assets`, `buzzword_definitions`, and `class_archetypes` are readable by anyone
 *   but are not writable by clients. This is the most secure posture, assuming an admin or backend process manages this content.
 * - Default Secure: Any path not explicitly matched is denied access. All write operations require authentication.
 *
 * Denormalization for Authorization: The `SharingCard` documents under `/users/{userId}/sharing_cards` contain a denormalized
 * `userProfileId` field. This allows security rules to validate ownership on creation without needing a costly `get()` call
 * to the parent user profile, leading to simpler and more performant rules.
 *
 * Structural Segregation: User-private data (profiles, sharing cards) is segregated into the `/users/{userId}` path,
 * while public data (`satire_assets`, `buzzword_definitions`) resides in its own top-level collections. This
 * separation simplifies security logic, preventing accidental exposure of private data and allowing for safe, efficient
 * public list operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the fundamental check for resource ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks for ownership on an existing resource.
     * CRITICAL: Used for all update and delete operations to prevent acting on non-existent documents.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    // ----------------------------------------------------------------------
    // User-Owned Data
    // ----------------------------------------------------------------------

    /**
     * @description Secures a user's own profile document.
     * @path /users/{userId}
     * @allow (create) An authenticated user creating their own profile document for the first time.
     * @allow (get, update, delete) An authenticated user managing their own profile document.
     * @deny (list) Any user attempting to list all user profiles.
     * @deny (get) An authenticated user attempting to read another user's profile.
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures sharing cards, which are owned by a user.
     * @path /users/{userId}/sharing_cards/{sharingCardId}
     * @allow (create) The user creating a new sharing card within their own data space.
     * @allow (list) The user listing all of their own created sharing cards.
     * @deny (create) A user trying to create a sharing card under another user's ID.
     * @deny (update) A user trying to modify a sharing card they do not own.
     * @principle Enforces strict document ownership within a user-specific subcollection.
     */
    match /users/{userId}/sharing_cards/{sharingCardId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userProfileId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userProfileId == resource.data.userProfileId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures marketplace links, which are nested under a user's sharing card.
     * @path /users/{userId}/sharing_cards/{sharingCardId}/marketplace_links/{marketplaceLinkId}
     * @allow (create) The card owner adding a new marketplace link to their card.
     * @allow (delete) The card owner removing a marketplace link from their card.
     * @deny (get) Another user trying to read a specific marketplace link document.
     * @deny (list) Another user trying to list all links for a card they don't own.
     * @principle Inherits ownership from the parent path, ensuring only the card owner can manage associated links.
     */
    match /users/{userId}/sharing_cards/{sharingCardId}/marketplace_links/{marketplaceLinkId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.sharingCardId == sharingCardId;
      allow update: if isExistingOwner(userId) && request.resource.data.sharingCardId == resource.data.sharingCardId;
      allow delete: if isExistingOwner(userId);
    }

    // ----------------------------------------------------------------------
    // Public Read-Only Data
    // ----------------------------------------------------------------------

    /**
     * @description Allows public read access to satirical wit presets. Writes are disabled.
     * @path /satire_assets/{satireAssetId}
     * @allow (get, list) Any user, including unauthenticated ones, reading preset data.
     * @deny (create, update, delete) Any user attempting to modify the global presets.
     * @principle Secures global, read-only content. Assumes this data is managed by an admin via the console or a trusted backend.
     */
    match /satire_assets/{satireAssetId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to buzzword definitions. Writes are disabled.
     * @path /buzzword_definitions/{definitionId}
     * @allow (get, list) Any user, including unauthenticated ones, reading buzzword definitions.
     * @deny (create, update, delete) Any user attempting to modify the global definitions.
     * @principle Secures global, read-only content. Assumes this data is managed by an admin via the console or a trusted backend.
     */
    match /buzzword_definitions/{definitionId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Allows public read access to class archetypes. Writes are disabled.
     * @path /class_archetypes/{classArchetypeId}
     * @allow (get, list) Any user, including unauthenticated ones, reading class archetype data.
     * @deny (create, update, delete) Any user attempting to modify the global class archetypes.
     * @principle Secures global, read-only content. Assumes this data is managed by an admin via the console or a trusted backend.
     */
    match /class_archetypes/{classArchetypeId} {
      allow get: if true;
      allow list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}